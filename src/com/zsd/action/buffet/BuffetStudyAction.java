/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.zsd.action.buffet;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.actions.DispatchAction;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONArray;
import com.zsd.action.base.Transcode;
import com.zsd.factory.AppFactory;
import com.zsd.module.BuffetLoreRelateInfo;
import com.zsd.module.BuffetLoreStudyDetailInfo;
import com.zsd.module.BuffetLoreStudyLogInfo;
import com.zsd.module.BuffetQueInfo;
import com.zsd.module.BuffetSendInfo;
import com.zsd.module.BuffetStudyDetailInfo;
import com.zsd.module.JoinLoreRelation;
import com.zsd.module.LoreInfo;
import com.zsd.module.StudyLogInfo;
import com.zsd.module.json.LoreTreeMenuJson;
import com.zsd.page.PageConst;
import com.zsd.service.BuffetLoreRelateInfoManager;
import com.zsd.service.BuffetLoreStudyDetailManager;
import com.zsd.service.BuffetLoreStudyLogManager;
import com.zsd.service.BuffetSendInfoManager;
import com.zsd.service.BuffetStudyDetailManager;
import com.zsd.service.JoinLoreRelationManager;
import com.zsd.service.LoreInfoManager;
import com.zsd.service.UserManager;
import com.zsd.tools.CommonTools;
import com.zsd.tools.Convert;
import com.zsd.tools.CurrentTime;
import com.zsd.util.Constants;

/** 
 * MyEclipse Struts
 * Creation date: 06-25-2019
 * 
 * XDoclet definition:
 * @struts.action validate="true"
 */
public class BuffetStudyAction extends DispatchAction {
	
	/**
	 * 自助餐在线学习页面
	 * @author wm
	 * @date 2019-6-25 上午11:19:48
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 */
	public ActionForward goBuffetStudyPage(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		// TODO Auto-generated method stub
		return mapping.findForward("buffetStudyPage");
	}
	
	/**
	 * 获取网络导师、班内老师发布的自助餐数据
	 * @author wm
	 * @date 2019-6-25 上午11:20:51
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception 
	 */
	public ActionForward getBuffetSendData(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		// TODO Auto-generated method stub
		BuffetSendInfoManager bsm = (BuffetSendInfoManager)AppFactory.instance(null).getApp(Constants.WEB_BUFFET_SEND_INFO);
		Integer userId = CommonTools.getLoginUserId(request);
		Integer subId = CommonTools.getFinalInteger("subId", request);
		Integer comStatus = CommonTools.getFinalInteger("comStatus", request);//完成状态，默认未全部0
		String sDate = CommonTools.getFinalStr("sDate", request);
		String eDate = CommonTools.getFinalStr("eDate", request);
		Integer pageNo = CommonTools.getFinalInteger("pageNo", request);//默认为1
		Integer pageSize = CommonTools.getFinalInteger("pageSize", request);//默认为10
		if(pageSize <= 0){
			pageSize = 10;
		}
		if(subId.equals(0)){
			subId = 2;//默认为数学
		}
		String msg = "error";
		Map<String,Object> map = new HashMap<String,Object>();
		if(userId > 0){
			Integer count = bsm.listBsInfoByOption(userId, subId, comStatus, sDate, eDate).size();
			if(count > 0){
				msg = "success";
				Integer countPage = PageConst.getPageCount(count, pageSize);
				pageNo = PageConst.getPageNo(pageNo, countPage);
				List<BuffetSendInfo> bsList = bsm.listPageInfoByOption(userId, subId, comStatus, sDate, eDate, pageNo, pageSize);
				List<Object> list_d = new ArrayList<Object>();
				for(BuffetSendInfo bs : bsList){
					Map<String,Object> map_d = new HashMap<String,Object>();
					map_d.put("bsId", bs.getId());
					map_d.put("subName", bs.getStudyLogInfo().getSubject().getSubName());
					map_d.put("loreName", bs.getStudyLogInfo().getLoreInfo().getLoreName());
					map_d.put("studyResult", bs.getStudyResult());//1:未完成，2:已完成
					map_d.put("allNumber", bs.getSendNumber());
					map_d.put("comNumber", bs.getComNumber());
					map_d.put("sendUserInfo", bs.getUser().getNickName());
					map_d.put("sendDate", bs.getSendTime().substring(0, 10));
					list_d.add(map_d);
				}
				map.put("studyList", list_d);
				map.put("countPage", countPage);
			}else{
				msg = "noInfo";
			}
		}
		map.put("result", msg);
		CommonTools.getJsonPkg(map, response);
		return null;
	}
	
	/**
	 * 获取指定发送的自助餐题库
	 * @author wm
	 * @date 2019-6-26 上午10:13:55
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward getBuffetQueData(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		// TODO Auto-generated method stub
		BuffetStudyDetailManager bsdm = (BuffetStudyDetailManager) AppFactory.instance(null).getApp(Constants.WEB_BUFFET_STUDY_DETAIL_INFO);
		Integer bsId = CommonTools.getFinalInteger("bsId", request);
		Integer userId = CommonTools.getLoginUserId(request);
		String msg = "noInfo";
		Map<String,Object> map = new HashMap<String,Object>();
		List<BuffetStudyDetailInfo> bsdList = bsdm.listInfoByBsId(bsId);
		if(bsdList.size() > 0){
			if(bsdList.get(0).getBuffetSendInfo().getStudyLogInfo().getUser().getId().equals(userId)){
				msg = "success";
				List<Object> list_d = new ArrayList<Object>();
				for(BuffetStudyDetailInfo bsd : bsdList){
					Map<String,Object> map_d = new HashMap<String,Object>();
					map_d.put("bsId", bsId);
					StudyLogInfo sl = bsd.getBuffetSendInfo().getStudyLogInfo();
					map_d.put("studyLogId", sl.getId());
					LoreInfo lore = sl.getLoreInfo();
					map_d.put("ediLoreId", lore.getId());//出版社下的知识点编号
					map_d.put("ediLoreName", lore.getLoreName());
					BuffetQueInfo buff = bsd.getBuffetQueInfo();
					map_d.put("buffetId", buff.getId());
					map_d.put("quoteLoreId", buff.getLoreInfo().getId());//通用版下的知识点编号
					map_d.put("queType", buff.getQueType());
					map_d.put("buffTypeId", buff.getBuffetTypeInfo().getId());
					map_d.put("buffTypeName", buff.getBuffetTypeInfo().getTypes());
					map_d.put("title", buff.getTitle());
					map_d.put("subject", buff.getSubject());
					map_d.put("answerA", buff.getA());
					map_d.put("answerB", buff.getB());
					map_d.put("answerC", buff.getC());
					map_d.put("answerD", buff.getD());
					map_d.put("answerE", buff.getE());
					map_d.put("answerF", buff.getF());
					map_d.put("resolution", buff.getResolution());
					map_d.put("myAnswer", bsd.getMyAnswer());
					if(!bsd.getMyAnswer().equals("")){//说明该题已做
						//答案选项选用做题时的答案选项
						map_d.put("answerA", bsd.getA());
						map_d.put("answerB", bsd.getB());
						map_d.put("answerC", bsd.getC());
						map_d.put("answerD", bsd.getD());
						map_d.put("answerE", bsd.getE());
						map_d.put("answerF", bsd.getF());
					}
					map_d.put("realAnswer", bsd.getRealAnswer());
					map_d.put("studyResult", bsd.getResult());
					map_d.put("traceComStatus", bsd.getTraceComStatus());
					map_d.put("currComStatus", bsd.getCurrComStatus());
					list_d.add(map_d);
				}
				map.put("bsdList", list_d);
			}else{
				msg = "error";
			}
		}
		map.put("result", msg);
		CommonTools.getJsonPkg(map, response);
		return null;
	}
	
	/**
	 * 做自助餐题，修改自助餐题库信息
	 * @author wm
	 * @date 2019-6-26 下午03:22:51
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward updateBuffetStudyDetail(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		// TODO Auto-generated method stub
		BuffetStudyDetailManager bsdm = (BuffetStudyDetailManager) AppFactory.instance(null).getApp(Constants.WEB_BUFFET_STUDY_DETAIL_INFO);
		BuffetSendInfoManager bsm = (BuffetSendInfoManager)AppFactory.instance(null).getApp(Constants.WEB_BUFFET_SEND_INFO);
		UserManager um = (UserManager)AppFactory.instance(null).getApp(Constants.WEB_USER_INFO);
		Integer userId = CommonTools.getLoginUserId(request);
		Integer bsdId = CommonTools.getFinalInteger("bsdId", request);
		String myAnswer = Transcode.unescape_new1("myAnswer", request);
		String answerOptionArrayStr = Transcode.unescape_new1("answerOptionArray",request);
		String[] answerOptionStr = {"","","","","",""};
		String msg = "noInfo";
		boolean flag = false;
		Integer result = 0;//0为错,1为对
		String dataBaseAnswerChar = "";
		Map<String,Object> map = new HashMap<String,Object>();
		if(userId > 0 && bsdId > 0){
			msg = "success";
			BuffetStudyDetailInfo bsd = bsdm.getEntityById(bsdId);
			if(bsd != null){
				Integer bsId = bsd.getBuffetSendInfo().getId();
				BuffetQueInfo bq = bsd.getBuffetQueInfo();
				String buffetType = bq.getBuffetTypeInfo().getTypes();
				String realAnswer = bq.getAnswer();
				if(buffetType.equals("问答题") || buffetType.equals("填空题")){
					if(myAnswer.indexOf("正确") >= 0){
						result = 1;
					}else{
						result = 0;
					}
					dataBaseAnswerChar = answerOptionArrayStr.replaceAll("&#wmd;", "'");
				}else{
					JSONArray answerOptionArray = JSON.parseArray(answerOptionArrayStr);
					String[] dataBaseAnswerArray = realAnswer.split(",");
					for(int j = 0; j < dataBaseAnswerArray.length; j++){
						for(int i = 0; i < answerOptionArray.size(); i++){
							String answerOption = answerOptionArray.get(i).toString();
							if(answerOption.indexOf("Module/commonJs/ueditor/jsp/lore") >= 0){
								//表示答案选项是图片--截取前面的路径
								answerOption = answerOption.replace("Module/commonJs/ueditor/jsp/lore/", "");
							}
							if(dataBaseAnswerArray[j].equals(answerOption)){
								dataBaseAnswerChar += Convert.NumberConvertBigChar(i)+",";
								break;
							}
						}
					}
					dataBaseAnswerChar = dataBaseAnswerChar.substring(0, dataBaseAnswerChar.length() - 1);
					if(buffetType.equals("多选题")){
						flag = false;//顺序可以不同
					}else{//不是多选题答案需要完全匹配(填空选择题、单选题，判断题)
						flag = true;
					}
					if(flag){//完全匹配
						if(dataBaseAnswerChar.equals(myAnswer)){
							result = 1;
						}else{
							result = 0;
						}
					}else{//答案顺序可以不同
						String[] myAnserArray = myAnswer.split(",");
						String[] realAnswerArray = dataBaseAnswerChar.split(",");
						String newMyAnswer = CommonTools.arraySort(myAnserArray);//排序后我的答案
						String newRealAnswer = CommonTools.arraySort(realAnswerArray);//排序后后台正确答案
						if(newMyAnswer.equals(newRealAnswer)){
							result = 1;
						}else{
							result = 0;
						}
					}
					for(int i = 0 ; i < answerOptionArray.size() ; i++){
						answerOptionStr[i] = answerOptionArray.get(i).toString().replaceAll("&#wmd;", "'");
					}
				}
				//修改自助餐答题情况
				boolean upFlag = bsdm.updateBuffetStudyDetailById(bsdId, myAnswer, result, CurrentTime.getCurrentTime(), 
						answerOptionStr[0], answerOptionStr[1], answerOptionStr[2],
				        answerOptionStr[3], answerOptionStr[4], answerOptionStr[5]);
				Integer coin = 0;//自助餐不增加金币数
				Integer experience = Constants.EXPERIENCE;
				if(upFlag){
					if(result.equals(1)){
						experience += Constants.EXPERIENCE;
						//当巴菲特题直接正确时--需要修改buffetStudyDetail中的traceCompleteFlag和currCompleteFlag的值为1
						bsdm.updateStatusById(bsdId, 1, 1);
						//修改自助餐发送记录中的完成次数
						bsm.updateBuffetSend(bsId, 0, 1);
					}
					um.updateUser(userId, coin, experience, 0, 0);
				}
			}
		}
		map.put("result", msg);
		map.put("studyResult", result);
		CommonTools.getJsonPkg(map, response);
		return null;
	}
	
	/**
	 * 获取当前自助餐下的关联知识点（筛去没有的）
	 * @author wm
	 * @date 2019-6-27 上午08:05:49
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward showRelationByBuffetAndLore(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		BuffetLoreRelateInfoManager blrm = (BuffetLoreRelateInfoManager) AppFactory.instance(null).getApp(Constants.WEB_BUFFET_LORE_RELATE_INFO);
		JoinLoreRelationManager jlrm = (JoinLoreRelationManager) AppFactory.instance(null).getApp(Constants.WEB_JOIN_LORE_RELATE_INFO);
		LoreInfoManager lm = (LoreInfoManager) AppFactory.instance(null).getApp(Constants.WEB_LORE_INFO);
		Integer buffetId = CommonTools.getFinalInteger("buffetId", request);
		Integer currBasicLoreId = CommonTools.getFinalInteger("currBasicLoreId", request);;//通用知识点
		Integer currLoreId = CommonTools.getFinalInteger("currLoreId", request);;//出版社下知识点编号
		String relateLoreIdStr = "";//该出版社下的关联知识点
		Integer editionId = 0;//当前知识点所在的出版社
		String msg = "noInfo";
		List<BuffetLoreRelateInfo> blrList = blrm.listInfoByOpt(buffetId, currBasicLoreId);
		if(blrList.size() == 0){//表示该巴菲特下没有关联，需要查询与之合并的知识点，查询合并的知识点有无巴菲特题
			//step1:根据通用知识点获取与之合并的其他知识点
			JoinLoreRelation jlr = jlrm.getInfoByLoreId(currBasicLoreId);
			if(jlr != null){
				String[] loreIdArray = jlr.getLoreIdArray().split(",");
				for(Integer i = 0 ; i < loreIdArray.length ; i++){
					Integer joinLoreId = Integer.parseInt(loreIdArray[i]);
					//step2:查询合并的知识点下面有无关联知识点（合并知识点共用关联知识点）
					if(!currBasicLoreId.equals(joinLoreId)){
						blrList = blrm.listInfoByOpt(buffetId, joinLoreId);
						if(blrList.size() > 0){
							break;
						}
					}
				}
			}
		}
		if(blrList.size() > 0){
			LoreInfo lore = lm.getEntityById(currLoreId);
			if(lore != null){
				editionId = lore.getChapter().getEducation().getEdition().getId();
				//通用版关联的知识点
				for(BuffetLoreRelateInfo blr : blrList){
					List<LoreInfo> loreList = lm.listInfoByMainLoreId(blr.getLoreInfoByLoreId().getId());
					for(LoreInfo lore_tmp : loreList){
						Integer relateLoreId = lore_tmp.getId();
						Integer inUse = lore_tmp.getInUse();
						if(inUse.equals(0)){//获取知识点的启用状态0：启用
							//通过通用版知识点编号获取被引用的知识点所在的出版社
							Integer joinLoreEditionId = lore_tmp.getChapter().getEducation().getEdition().getId();
							if(editionId.equals(joinLoreEditionId)){//两个出版社必须保持一致
								relateLoreIdStr += relateLoreId + ",";
								break;
							}
						}
					}
				}
			}
		}
		if(!relateLoreIdStr.equals("")){
			relateLoreIdStr = relateLoreIdStr.substring(0, relateLoreIdStr.length() - 1);
			msg = "success";
		}
		Map<String,String> map = new HashMap<String,String>();
		map.put("result", msg);
		map.put("relateLoreIdStr", relateLoreIdStr);
		CommonTools.getJsonPkg(map, response);
		return null;
	}
	
	/**
	 * 获取当前巴菲特发布记录的详细完成情况（opt=trace时必须traceFlag完成，防止恶意提交。opt=currCom主要用于提交后页面不刷新时答题状态不变化）
	 * false:1,true:0
	 * @author wm
	 * @date 2019-6-27 上午09:41:16
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward getCurrBuffetFlag(ActionMapping mapping ,ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		BuffetStudyDetailManager bsdm = (BuffetStudyDetailManager) AppFactory.instance(null).getApp(Constants.WEB_BUFFET_STUDY_DETAIL_INFO);
		Integer bsdId = CommonTools.getFinalInteger("bsdId", request);
		String opt = CommonTools.getFinalStr("opt", request);//trace(溯源完成标记),currCom(当前自助餐完成标记)
		BuffetStudyDetailInfo bsd = bsdm.getEntityById(bsdId);
		boolean flag = true;
		Integer status = 0;//0:未完成,1:已完成
		if(bsd != null){
			if(opt.equals("trace")){
				status = bsd.getTraceComStatus();
			}else if(opt.equals("currCom")){
				status = bsd.getCurrComStatus();
			}
			if(status.equals(1)){
				flag = false;
			}
		}
		Map<String,Boolean> map = new HashMap<String,Boolean>();
		map.put("result", flag);
		CommonTools.getJsonPkg(map, response);
		return null;
	}
	
	/**
	 * 根据巴菲特学习记录编号修改当前巴菲特学习记录已完成currCompleteFlag=1
	 * @author wm
	 * @date 2019-6-27 上午10:04:21
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward updateCurrCompleteFlag(ActionMapping mapping ,ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		BuffetStudyDetailManager bsdm = (BuffetStudyDetailManager) AppFactory.instance(null).getApp(Constants.WEB_BUFFET_STUDY_DETAIL_INFO);
		BuffetSendInfoManager bsm = (BuffetSendInfoManager)AppFactory.instance(null).getApp(Constants.WEB_BUFFET_SEND_INFO);
		Integer bsdId = CommonTools.getFinalInteger("bsdId", request);
		boolean flag = bsdm.updateStatusById(bsdId, 1, 1);//自助餐都完成了，肯定溯源也完成
		if(flag){
			BuffetSendInfo bs = bsdm.getEntityById(bsdId).getBuffetSendInfo();
			Integer bsId = bs.getId();
			Integer allNumber = bs.getSendNumber();
			if(allNumber > bs.getComNumber()){
				//分两种情况（当最后一道题）
				//1:直接答题正确，这时completeNumber已经+1，所以不能再执行增加
				//2:答题错误，进入溯源，溯源完成后，点击完成，这时completeNumber没+1，所以要执行增加
				Integer isFinish = 0;
//				if(allNumber.equals(bs.getComNumber() + 1)){//最后一题
//					isFinish = 2;//学习完成
//				}
				flag = bsm.updateBuffetSend(bsId, isFinish, 1);
			}
		}
		Map<String,Boolean> map = new HashMap<String,Boolean>();
		map.put("result", flag);
		CommonTools.getJsonPkg(map, response);
		return null;
	}
	
	/**
	 * 自助餐答题错误后导向关联知识点的溯源页面
	 * @author wm
	 * @date 2019-6-27 上午10:33:29
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward goBuffetLoreTracePage(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		// TODO Auto-generated method stub
	
		return mapping.findForward("buffetTracePage");
	}
	
	/**
	 * 自助餐答题错误后获取关联知识点的溯源路线如图
	 * @author wm
	 * @date 2019-6-27 上午10:35:28
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward getBuffetLoreTraceDate(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		// TODO Auto-generated method stub
		BuffetStudyDetailManager bsdm = (BuffetStudyDetailManager) AppFactory.instance(null).getApp(Constants.WEB_BUFFET_STUDY_DETAIL_INFO);
		BuffetLoreStudyLogManager blslm = (BuffetLoreStudyLogManager) AppFactory.instance(null).getApp(Constants.WEB_BUFFET_LORE_STUDY_LOG_INFO);
		BuffetLoreStudyDetailManager blsdm = (BuffetLoreStudyDetailManager) AppFactory.instance(null).getApp(Constants.WEB_BUFFET_LORE_STUDY_DETAIL_INFO);
		LoreInfoManager lm = (LoreInfoManager) AppFactory.instance(null).getApp(Constants.WEB_LORE_INFO);
		Integer bsdId = CommonTools.getFinalInteger("bsdId", request);
		BuffetStudyDetailInfo bsd = bsdm.getEntityById(bsdId);
		Map<String,Object> map = new HashMap<String,Object>();
		String nextLoreIdArray = "";//下级知识典编号数组
		Integer isFinish = 0;
		Integer studyLogId = 0;
		Integer totalMoney = -1;
		String path = "";//顺序路线图(诊断时)
		String pathChi = "";
		String studyPath = "";//学习的路线
		String studyPathChi = "";
		Integer step = 0;
		Integer stepComplete = 0;
		Integer access = -1;
		Integer currentLoreId = 0;
		Integer option = 0;//1--诊断,2--学习
		String successStep = "";
		Integer success = -1;//0:正确,1:不正确
		String nextLoreStep = "上一级的关联知识点";
		String currentloreName_study = "";//当前5步学习法时的知识典名称
		Integer basicLoreId = 0;
		Integer buffetId = 0;
		String buffetName = "";
		if(bsd != null){
			basicLoreId = bsd.getBuffetSendInfo().getStudyLogInfo().getLoreInfo().getId();//发布巴菲特的学习的知识点编号
			buffetId = bsd.getBuffetQueInfo().getId();
			buffetName = bsd.getBuffetQueInfo().getTitle();
			String[] pathArr = CommonTools.getBuffetLorePath(buffetId, buffetName, basicLoreId, "diagnosis");
			path =  pathArr[0];
			pathChi = pathArr[1];
			LoreTreeMenuJson ltmj = new LoreTreeMenuJson();
			//通过buffet_study_detail_id获取buffet_lore_study_log_id
			BuffetLoreStudyLogInfo blsl = blslm.getEntityByBsdId(bsdId);
			if(blsl == null){//表示第一次，还未进行巴菲特知识点学习
				currentLoreId = buffetId;//目的为了获取当前级别(把第一级巴菲特编号赋值给currLoreId)
				String[] pathArray = path.split(":");
				Integer currentI = CommonTools.getCurrentStep(pathArray, currentLoreId);
				if(currentI + 1 == pathArray.length){
					//表示是最后一级（只有一级）
					//溯源完成，开始学习
				}else{
					nextLoreIdArray = "";
					String[] nextPathArray = pathArray[currentI + 1].split(",");
					Integer nextPathLength = nextPathArray.length;
					for(Integer k = 0 ; k < nextPathLength ; k++){
						String[] nextDetailPathArray = nextPathArray[k].split("\\|");
						for(Integer l = 0 ; l < nextDetailPathArray.length ; l++){
							nextLoreIdArray += nextDetailPathArray[l] + ",";
						}
					}
					if(nextLoreIdArray.length() > 0){
						nextLoreIdArray = nextLoreIdArray.substring(0, nextLoreIdArray.length() - 1);
					}
					successStep = buffetName;
					success = 1;
				}
			}else{
				totalMoney = blsl.getCurrentGold() * 10;
				stepComplete = blsl.getStepComlete();
				step = blsl.getStep();
				access = blsl.getAccess();
				studyLogId = blsl.getId();
				if(blsl.getIsFinish().equals(1)){//表示未全部完成,2:已完成
					//从detail表中获取指定logId的最后一条详情
					List<BuffetLoreStudyDetailInfo> bsdList = blsdm.listLastInfoByLogId(studyLogId);
					//获取该题对应的知识点编号
					currentLoreId = bsdList.get(0).getLoreInfo().getId();
					if(stepComplete > 0){//本阶段答题已完成(还未进行下一级)
						if(step.equals(1)){
							//通过当前知识点获取下级子知识点
							String[] pathArray = path.split(":");
							Integer currentI = CommonTools.getCurrentStep(pathArray, currentLoreId);
							if(currentI + 1 == pathArray.length){
								
							}else{
								option = 1;
								nextLoreIdArray = "";
								String[] nextPathArray = pathArray[currentI + 1].split(",");
								Integer nextPathLength = nextPathArray.length;
								for(Integer k = 0 ; k < nextPathLength ; k++){
									String[] nextDetailPathArray = nextPathArray[k].split("\\|");
									for(Integer l = 0 ; l < nextDetailPathArray.length ; l++){
										nextLoreIdArray += nextDetailPathArray[l] + ",";
									}
								}
								if(nextLoreIdArray.length() > 0){
									nextLoreIdArray = nextLoreIdArray.substring(0, nextLoreIdArray.length() - 1);
								}
								successStep = "本知识点";
								success = 1;
							}
						}else if(step.equals(2)){//表示关联知识点诊断完成/或者是某一级的关联知识点全部正确，需要进入学习阶段
							String[] studyPathArr = ltmj.getStudyPath(path,pathChi);
							studyPath = studyPathArr[0];
							studyPathChi = studyPathArr[1];
							String[] studyPath_new_arr = CommonTools.getStudyPath_new(studyPath,studyPathChi, currentLoreId);
							studyPath = studyPath_new_arr[0];
							studyPathChi = studyPath_new_arr[1];
							//根据当前currentLoreId截取studyPath
							option = 2;
							if(access == 1){//当前关联知识典诊断全部正确，进入当前知识典的下级进行学习
								Integer stepNumber = CommonTools.getCurrentStep(path.split(":"), currentLoreId);
								successStep = stepNumber+"级关联知识点的诊断题";
								success = 3;
								//获取studyPath_new的第二组的数据中的第一组数据
								nextLoreIdArray = studyPath.split(":")[1].split("\\|")[0];
								if(nextLoreIdArray.equals(String.valueOf(basicLoreId))){
									nextLoreStep = "本知识点";
								}
							}else{//学习完了所有的关联知识典，返回逆序进行全部学习access=2
								Integer stepNumber = CommonTools.getCurrentStep(path.split(":"), currentLoreId);
								successStep = stepNumber+"级关联知识点的诊断题";
								nextLoreIdArray = String.valueOf(currentLoreId);
								success = 2;
							}
						}else if(step.equals(3)){
							option = 2;
							success = 5;
							nextLoreIdArray = String.valueOf(basicLoreId);
							String[] studyPathArr = ltmj.getStudyPath(path,pathChi);
							studyPath = studyPathArr[0];
							studyPathChi = studyPathArr[1];
						}
					}else{//本阶段答题完成，但本知识点所有的关联性诊断未完成
						//不会存在access=1的情况，1表示当前题全部正确，如果是全部正确的话，那么stepComplete>0
						if(step == 3){//
							if(access.equals(4)){//第一次进入再次诊断（列出再次诊断全部题）
								option = 2;
								success = 4;
								nextLoreIdArray = String.valueOf(currentLoreId);
								Integer stepNumber = CommonTools.getCurrentStep(path.split(":"), currentLoreId);
								successStep = stepNumber+"级关联知识点的诊断题";
								//获取studyPath_new的第二组的数据中的第一组数据
								currentloreName_study = lm.getEntityById(Integer.parseInt(nextLoreIdArray)).getLoreName();
								if(nextLoreIdArray.equals(String.valueOf(buffetId))){
									nextLoreStep = "本知识点";
								}
							}else if(access.equals(41)){
								option = 2;
								success = 4;
								nextLoreIdArray = String.valueOf(currentLoreId);
								Integer stepNumber = CommonTools.getCurrentStep(path.split(":"), currentLoreId);
								String currentLoreName = lm.getEntityById(currentLoreId).getLoreName();
								successStep = stepNumber+"级关联知识点("+currentLoreName+")";
								//获取studyPath_new的第二组的数据中的第一组数据
								currentloreName_study = lm.getEntityById(Integer.parseInt(nextLoreIdArray)).getLoreName();
								if(nextLoreIdArray.equals(String.valueOf(buffetId))){
									nextLoreStep = "本知识点";
								}
							}else if(access.equals(3)){//之前没把再次诊断全部做对（列出做错的再次诊断题）
								option = 2;
								success = 4;
								nextLoreIdArray = String.valueOf(currentLoreId);
								Integer stepNumber = CommonTools.getCurrentStep(path.split(":"), currentLoreId);
								String currentLoreName = lm.getEntityById(currentLoreId).getLoreName();
								successStep = stepNumber+"级关联知识点("+currentLoreName+")";
								//获取studyPath_new的第二组的数据中的第一组数据
								currentloreName_study = lm.getEntityById(Integer.parseInt(nextLoreIdArray)).getLoreName();
								if(nextLoreIdArray.equals(String.valueOf(buffetId))){
									nextLoreStep = "本知识点";
								}
							}else if(access.equals(31)){//再次诊断完成提交后（31）
								option = 2;
								success = 2;
								nextLoreIdArray = String.valueOf(currentLoreId);
								Integer stepNumber = CommonTools.getCurrentStep(path.split(":"), currentLoreId);
								String currentLoreName = lm.getEntityById(currentLoreId).getLoreName();
								successStep = stepNumber+"级关联知识点("+currentLoreName+")";
								//获取studyPath_new的第二组的数据中的第一组数据
								currentloreName_study = lm.getEntityById(Integer.parseInt(nextLoreIdArray)).getLoreName();
								if(nextLoreIdArray.equals(String.valueOf(buffetId))){
									nextLoreStep = "本知识点";
								}
							}else if(access.equals(2)){//进入5步学习法
								
							}else if(access.equals(1)){//题做完，全部正确（需要定位到下一个知识点）
								String studyPath_new = CommonTools.getCurrentStudyPath_new(studyPath, currentLoreId);//获取当前知识点以后的知识点
								Integer currentLoreId_new = Integer.parseInt(studyPath_new.split(":")[0].split("\\|")[0]);
								option = 2;
								nextLoreIdArray = String.valueOf(currentLoreId_new);
								success = 5;//进入5步学习法
								//获取studyPath_new的第二组的数据中的第一组数据
								currentloreName_study = lm.getEntityById(Integer.parseInt(nextLoreIdArray)).getLoreName();
								if(nextLoreIdArray.equals(String.valueOf(buffetId))){
									nextLoreStep = "本知识点";
								}
							}else if(access.equals(0)){//表示已经做了再次诊断题，但是没做完（将已做的题和未做的列出来）
								//根据当前currentLoreId截取studyPath
								option = 2;
								nextLoreIdArray = String.valueOf(currentLoreId);
								Integer stepNumber = CommonTools.getCurrentStep(path.split(":"), currentLoreId);
								successStep = stepNumber+"级关联知识点";
								success = 0;//再次诊断未做完
								//获取studyPath_new的第二组的数据中的第一组数据
								currentloreName_study = lm.getEntityById(Integer.parseInt(nextLoreIdArray)).getLoreName();
								if(nextLoreIdArray.equals(String.valueOf(buffetId))){//同上，如何判定当前到了巴菲特的阶段
									nextLoreStep = "本知识点";
								}
							}
						}else if(step.equals(4)){//到4结束
							if(access.equals(2)){//溯源完成
								option = 2;
								nextLoreIdArray = String.valueOf(buffetId);
								success = 6;//进入巴菲特的解析
							}
						}else{
							if(blsl.getAccess().equals(2)){//本阶段题部分正确
								nextLoreIdArray = "";
								option = 1;
								String[] pathArray = path.split(":");
								Integer currentI = CommonTools.getCurrentStep(pathArray, currentLoreId);
								String[] currentPathArray = pathArray[currentI+1].split("\\|");
								for(Integer i = 0 ; i < currentPathArray.length ; i++){
									nextLoreIdArray += currentPathArray[i]+",";
								}
								if(nextLoreIdArray.length() > 0){
									nextLoreIdArray = nextLoreIdArray.substring(0, nextLoreIdArray.length() - 1);
								}
								Integer stepNumber = CommonTools.getCurrentStep(path.split(":"), currentLoreId);
								successStep = stepNumber+"级关联知识点的诊断题";
								success = 1;
							}else{//本阶段还未点最后的提交，access为0
								nextLoreIdArray = "";
								option = 1;
								String[] pathArray = path.split(":");
								Integer currentI = CommonTools.getCurrentStep(pathArray, currentLoreId);											
								String[] currentPathArray = pathArray[currentI].split("\\|");
								for(Integer i = 0 ; i < currentPathArray.length ; i++){
									nextLoreIdArray += currentPathArray[i]+",";
								}
								if(nextLoreIdArray.length() > 0){
									nextLoreIdArray = nextLoreIdArray.substring(0, nextLoreIdArray.length() - 1);
								}
								Integer stepNumber = CommonTools.getCurrentStep(path.split(":"), currentLoreId);
								if(stepNumber == 0){
									successStep = "本知识点";
									success = 0;
								}else{
									success = 1;
									successStep = stepNumber+"级关联知识点的诊断题";
								}
							}
						}
					}
				}else if(blsl.getIsFinish().equals(2)){//表示全部完成
					step = blsl.getStep();
					//从detail表中获取指定logId的最后一条详情
					List<BuffetLoreStudyDetailInfo> blsdList = blsdm.listLastInfoByLogId(studyLogId);
					//获取最后（最近）的一条答题详情
					BuffetLoreStudyDetailInfo blsdLastInfo = blsdList.get(0);
					//获取该题对应的知识点编号
					currentLoreId = blsdLastInfo.getLoreQuestion().getLoreInfo().getId();
					studyPath = "";
					if(step == 1){//表示是本知识典诊断时一次性全部正确通过
						option = 1;
						success = 2;
						path = String.valueOf(currentLoreId);
						nextLoreIdArray = String.valueOf(currentLoreId);
					}else{//通过溯源完成的

						option = 2;
						nextLoreIdArray = "0";
						successStep = "本知识点的诊断题";
						success = 6;//全部完成
					}
				}
			}
		}
		map.put("option", option);
		map.put("totalMoney", totalMoney);
		map.put("success", success);
		map.put("path", path);
		map.put("pathChi", pathChi);
		map.put("studyPath", studyPath);
		map.put("studyPathChi", studyPathChi);
		map.put("nextLoreIdArray", nextLoreIdArray);
		map.put("successStep", successStep);
		map.put("nextLoreStep", nextLoreStep);
		map.put("currentloreName_study", currentloreName_study);
		map.put("access", access);
		map.put("buffetId", buffetId);
		map.put("buffetName", buffetName);
		map.put("bsdId", bsdId);
		
		map.put("studyLogId", studyLogId);
		map.put("isFinish", isFinish);
		return null;
	}
}